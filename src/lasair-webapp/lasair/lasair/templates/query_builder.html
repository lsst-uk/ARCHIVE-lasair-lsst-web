<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

<script type="text/javascript">
/* respond to clicking a checkbox */
function puttext() {
  var boxes = document.getElementsByName('put');
  var nonobjects = 0;
  var text = '';
  var checked_wl = '';
  var checked_ar = '';
  for(i=0; i<boxes.length; i++){
    if(boxes[i].checked && boxes[i].id != 'objects'){
      nonobjects += 1;
    }
    if(boxes[i].checked && boxes[i].id == 'watchlist'){
      var radios = document.getElementsByName("wl");
      for (var j = 0; j < radios.length; j++) {
        if (radios[j].checked) {
          checked_wl = radios[j].value;
        }
      }
    }
    if(boxes[i].checked && boxes[i].id == 'area'){
      var radios = document.getElementsByName("ar");
      for (var j = 0; j < radios.length; j++) {
        if (radios[j].checked) {
          checked_ar = radios[j].value;
        }
      }
    }
  }
  if(nonobjects > 1){
    document.getElementById('objects').checked = true;
  }
  var nt = 0;
  for(i=0; i<boxes.length; i++){
    if(boxes[i].checked){
      if(nt > 0){
        text += ', '
      }
      if(boxes[i].id == 'watchlist'){
        if(checked_wl.length == 0){
          continue;
	} else {
          text += 'watchlist:' + checked_wl;
        }
      }
      else if(boxes[i].id == 'area'){
        if(checked_ar.length == 0){
          continue;
	} else {
          text += 'area:' + checked_ar;
        }
      }
      else {
        text += boxes[i].id;
      }
      nt += 1;
    }
  }
  document.getElementById("tables").value = text;
}

/* take the table text and fill in the checkboxes */
function check_boxes() {
  var tables = document.getElementById("tables").value;
	console.log(tables);
  var boxes = document.getElementsByName('put');
  for(i=0; i<boxes.length; i++){
    if(tables.indexOf(boxes[i].id) != -1){
      boxes[i].checked = true;
    }
  }
  var radios = document.getElementsByName("wl");
  document.getElementById('watchlistradios' ).style.display = 'none';
  for (var j = 0; j < radios.length; j++) {
    if (tables.indexOf('watchlist:' + radios[j].value) != -1) {
      radios[j].checked = true;
      document.getElementById('watchlistradios' ).style.display = 'block';
    }
  }
  var radios = document.getElementsByName("ar");
  document.getElementById('arearadios' ).style.display = 'none';
  for (var j = 0; j < radios.length; j++) {
    if (tables.indexOf('area:' + radios[j].value) != -1) {
      radios[j].checked = true;
      document.getElementById('arearadios' ).style.display = 'block';
    }
  }
}

function showwatchlistradiolist(){
    if(document.getElementById('watchlist' ).checked){
        document.getElementById('watchlistradios' ).style.display = 'block';
    } else {
        document.getElementById('watchlistradios' ).style.display = 'none';
    }
}
function showarearadiolist(){
    if(document.getElementById('area' ).checked){
        document.getElementById('arearadios' ).style.display = 'block';
    } else {
        document.getElementById('arearadios' ).style.display = 'none';
    }
}
</script>

<script type="text/javascript">
$(function() {
var availableTags = [
	"objects.objectId,
"objects.decmean,
"objects.decstd,
"objects.ramean,
"objects.rastd,
"objects.glatmean,
"objects.glonmean,
"objects.jdgmax,
"objects.gmag,
"objects.dmdt_g,
"objects.dmdt_g_2,
"objects.mag_g02,
"objects.mag_g08,
"objects.mag_g28,
"objects.maggmax,
"objects.maggmean,
"objects.maggmin,
"objects.jdrmax,
"objects.mag_r02,
"objects.mag_r08,
"objects.mag_r28,
"objects.rmag,
"objects.dmdt_r,
"objects.dmdt_r_2,
"objects.magrmax,
"objects.magrmean,
"objects.magrmin,
"objects.jdmax,
"objects.jdmin,
"objects.ncand,
"objects.ncandgp,
"objects.distpsnr1,
"objects.sgscore1,
"objects.sgmag1,
"objects.srmag1,
"objects.htm16,
"sherlock_classifications.classification,
"sherlock_classifications.objectId,
"sherlock_classifications.association_type,
"sherlock_classifications.catalogue_table_name,
"sherlock_classifications.catalogue_object_id,
"sherlock_classifications.catalogue_object_type,
"sherlock_classifications.raDeg,
"sherlock_classifications.decDeg,
"sherlock_classifications.separationArcsec,
"sherlock_classifications.northSeparationArcsec,
"sherlock_classifications.eastSeparationArcsec,
"sherlock_classifications.physical_separation_kpc,
"sherlock_classifications.direct_distance,
"sherlock_classifications.distance,
"sherlock_classifications.z,
"sherlock_classifications.photoZ,
"sherlock_classifications.photoZErr,
"sherlock_classifications.Mag,
"sherlock_classifications.MagFilter,
"sherlock_classifications.MagErr,
"sherlock_classifications.classificationReliability,
"sherlock_classifications.annotator,
"sherlock_classifications.additional_output,
"sherlock_classifications.description,
"sherlock_classifications.summary,
"watchlist_hits.objectId",
"watchlist_hits.arcsec",
"watchlist_hits.name",
"watchlist_hits.ndethist"
];
function splitComma( val ) {
  return val.split( /,\s*/ );
}
function splitSpace( val ) {
  return val.split( / \s*/ );
}
function extractLastComma( term ) {
  return splitComma( term ).pop();
}
function extractLastSpace( term ) {
  return splitSpace( term ).pop();
}

$( "#selected" )
  // don't navigate away from the field on tab when selecting an item
  .bind( "keydown", function( event ) {
    if ( event.keyCode === $.ui.keyCode.TAB &&
        $( this ).autocomplete( "instance" ).menu.active ) {
      event.preventDefault();
    }
  })
  .autocomplete({
    minLength: 0,
    source: function( request, response ) {
      // delegate back to autocomplete, but extract the last term
      response( $.ui.autocomplete.filter(
        availableTags, extractLastSpace( request.term ) ) );
    },
    focus: function() {
      // prevent value inserted on focus
      return false;
    },
    select: function( event, ui ) {
      var terms = splitSpace( this.value );
      // remove the current input
      terms.pop();
      // add the selected item
      terms.push( ui.item.value );
      // add placeholder to get the comma-and-space at the end
//      terms.push( "" );
      this.value = terms.join( " " );
      return false;
    }
    });
$( "#conditions" )
  // don't navigate away from the field on tab when selecting an item
  .bind( "keydown", function( event ) {
    if ( event.keyCode === $.ui.keyCode.TAB &&
        $( this ).autocomplete( "instance" ).menu.active ) {
      event.preventDefault();
    }
  })
  .autocomplete({
    minLength: 0,
    source: function( request, response ) {
      // delegate back to autocomplete, but extract the last term
      response( $.ui.autocomplete.filter(
        availableTags, extractLastSpace( request.term ) ) );
    },
    focus: function() {
      // prevent value inserted on focus
      return false;
    },
    select: function( event, ui ) {
      var terms = splitSpace( this.value );
      // remove the current input
      terms.pop();
      // add the selected item
      terms.push( ui.item.value );
      // add placeholder to get the comma-and-space at the end
//      terms.push( "" );
      this.value = terms.join( " " );
      return false;
    }
    });
   });
</script>

<script type="text/javascript">
$(document).ready(function(){
  check_boxes();
});
</script>



<div class ="form-group">
{% csrf_token %} 

<b><font color="red">SELECT ATTRIBUTES</font></b>
<tt><textarea class="form-control" rows="4" cols="40" name="selected" id="selected">{{ myquery.selected }}</textarea></tt>

<b><font color="red">TABLES TO USE</font></b>
<div style="display:none">
<tt><textarea class="form-control" rows="1" cols="40" name="tables" id="tables">{{ myquery.tables }}</textarea></tt>
</div>
<table class="table table-bordered"> 
<tr class="bg-primary">

<td> <font size=+1>
<input type="checkbox" name="put" id="objects"                  onclick="puttext();"> objects
</font></td>

<td> 
<input type="checkbox" name="put" id="sherlock_classifications"    onclick="puttext();"> sherlock_classifications
</td>
</tr>

<tr class="bg-primary">
<td><input type="checkbox" name="put" id="watchlist"    onclick="showwatchlistradiolist();puttext();"> Watchlist
<div id="watchlistradios">
{% for wl in watchlists %}
&nbsp;&nbsp;&nbsp;<input type="radio" name="wl" value="{{ wl.wl_id }}" onclick="puttext();"> {{ wl.name }}, ID={{ wl.wl_id }}
{% if not wl.active %}<i>(inactive)</i>{% endif %}
<br/>
{% endfor %}
</div>
</td>

<td><input type="checkbox" name="put" id="area"    onclick="showarearadiolist();puttext();"> Area
<div id="arearadios">
{% for ar in areas %}
&nbsp;&nbsp;&nbsp;<input type="radio" name="ar" value="{{ ar.ar_id }}" onclick="puttext();"> {{ ar.name }}, ID={{ ar.ar_id }}
{% if not ar.active %}<i>(inactive)</i>{% endif %}
<br/>
{% endfor %}
</div>
</td>

</tr>


</table>

<b><font color="red">WHERE</font></b>
<tt><textarea class="form-control" rows="4" cols="40" name="conditions" id="conditions">{{ myquery.conditions }}</textarea></tt>
</div>

<input class="form-control" type="hidden" name="page" value="{{ page }}"/><br/>

